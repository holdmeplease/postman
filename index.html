<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰§æœ¬è¯„ä»·åŠ©æ‰‹ - è°ƒè¯•ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-gradient { background: linear-gradient(135deg, #ff6b6b 0%, #ee0979 100%); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 flex flex-col items-center">

  <!-- å¾®ä¿¡å¼•å¯¼é®ç½© -->
  <div id="wx-mask" class="hidden fixed inset-0 bg-black/90 z-50 animate-fade-in flex flex-col items-end p-6">
    <img src="https://img.icons8.com/ios/100/ffffff/curved-arrow.png" class="w-16 h-16 rotate-[270deg] mb-4">
    <div class="text-white text-right">
      <h2 class="text-2xl font-bold">è¯·ç‚¹å‡»å³ä¸Šè§’ [...]</h2>
      <p class="text-lg">é€‰æ‹© <span class="text-pink-400 font-bold">[åœ¨æµè§ˆå™¨æ‰“å¼€]</span></p>
      <p class="text-sm mt-2 opacity-80">åœ¨æµè§ˆå™¨ä¸­å†ç‚¹â€œæ‰“å¼€ç‚¹è¯„ APPâ€ï¼Œå¯é¿å…å‰ªè´´æ¿è¢«è¦†ç›–</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/80 text-white text-sm px-4 py-2 rounded-full z-50 animate-fade-in">
    æç¤º
  </div>

  <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden mb-6 mt-4">
    <div class="aspect-square bg-gray-100 relative">
      <img id="role-img" src="" class="w-full h-full object-cover hidden">
      <div id="img-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">æ­£åœ¨å‡†å¤‡è§’è‰²...</div>
    </div>
    <div class="p-6">
      <h2 id="role-name" class="text-2xl font-black text-gray-800 mb-2">åŠ è½½ä¸­...</h2>
      <div id="review-box" class="bg-gray-50 p-4 rounded-2xl text-gray-600 leading-relaxed text-sm">æ­£åœ¨åŠ è½½æ–‡æ¡ˆ...</div>

      <!-- æ–°å¢ï¼šå‰ªè´´æ¿æ¢å¤æŒ‰é’®ï¼ˆè¢«è¦†ç›–æ—¶ç”¨ï¼‰ -->
      <button id="restore-btn"
              onclick="restoreCopy()"
              class="hidden mt-4 w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 rounded-xl active:scale-95 transition-all">
        ğŸ” æ–‡æ¡ˆå¯èƒ½è¢«è¦†ç›–ï¼Œç‚¹æˆ‘æ¢å¤å¤åˆ¶
      </button>
    </div>
  </div>

  <div class="w-full max-w-md space-y-4">
    <div class="flex gap-3">
      <button onclick="copyReviewText()" class="flex-1 bg-white border-2 border-pink-500 text-pink-600 font-bold py-4 rounded-xl active:scale-95 transition-all">
        1. å¤åˆ¶è¯„ä»·æ–‡æ¡ˆ
      </button>

      <button onclick="jumpToApp()" class="flex-1 btn-gradient text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
        2. æ‰“å¼€ç‚¹è¯„ APP
      </button>
    </div>
    <p class="text-center text-gray-400 text-[10px]">å»ºè®®ï¼šå…ˆç‚¹1å¤åˆ¶ï¼Œå†ç‚¹2æ‰“å¼€ç‚¹è¯„ï¼›è‹¥ä»åˆ«çš„é¡µé¢å›æ¥å‘ç°æ–‡æ¡ˆæ²¡äº†ï¼Œç‚¹â€œæ¢å¤å¤åˆ¶â€ã€‚</p>
  </div>

  <script>
    /***********************
     * 0) å°å·¥å…·
     ***********************/
    function toast(msg, ms = 1600) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.add('hidden'), ms);
    }

    function isWechat() { return /MicroMessenger/i.test(navigator.userAgent); }
    function isAndroid() { return /Android/i.test(navigator.userAgent); }
    function isIOS() { return /iPhone|iPad|iPod/i.test(navigator.userAgent); }

    /***********************
     * 1) åˆå§‹åŒ–æ•°æ®
     ***********************/
    const urlParams = new URLSearchParams(window.location.search);
    const roleId = urlParams.get('id') || '0';
    const roles = [
      { name: "æ¬§é˜³åƒé‡‘", img: "img1.jpg", text: "è¿™æ¬¡ç©çš„å‰§æœ¬æ€å¤ªç²¾å½©äº†ï¼æˆ‘æŠ½åˆ°çš„è§’è‰²å¾ˆæœ‰æ·±åº¦ï¼Œå‰§æƒ…åè½¬å†åè½¬ï¼Œå¼ºçƒˆæ¨èï¼" },
      { name: "ç¥ç§˜ç®¡å®¶", img: "img2.jpg", text: "æ•´åœºä¸‹æ¥æ°›å›´æ„Ÿæ‹‰æ»¡ï¼Œåº—å‘˜å°å§å§æœåŠ¡ä¹Ÿç‰¹åˆ«å¥½ï¼Œè¯„ä»·å¿…ç»™äº”æ˜Ÿï¼" }
    ];
    const role = roles[parseInt(roleId)] || roles[0];

    document.getElementById('role-name').innerText = role.name;
    document.getElementById('review-box').innerText = role.text;

    const img = document.getElementById('role-img');
    img.src = role.img;
    img.onload = () => {
      img.classList.remove('hidden');
      document.getElementById('img-placeholder').classList.add('hidden');
    };

    /***********************
     * 2) å¾®ä¿¡ç¯å¢ƒï¼šåªåšå¼•å¯¼ï¼Œä¸å°è¯•å”¤èµ·
     ***********************/
    if (isWechat()) {
      document.getElementById('wx-mask').classList.remove('hidden');
    }

    /***********************
     * 3) å¤åˆ¶é€»è¾‘ï¼šå¤åˆ¶æˆåŠŸåæŠŠæ–‡æ¡ˆæŒä¹…åŒ–ï¼Œé˜²æ­¢è¢«è¦†ç›–
     ***********************/
    async function copyReviewText() {
      const text = document.getElementById('review-box').innerText;

      // å­˜æ¡£ï¼šåé¢å¯â€œæ¢å¤å¤åˆ¶â€
      localStorage.setItem('dp_review_text', text);
      localStorage.setItem('dp_review_ts', String(Date.now()));
      document.getElementById('restore-btn').classList.add('hidden');

      // ç­–ç•¥ A: Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          toast("âœ… å¤åˆ¶æˆåŠŸï¼ç°åœ¨ç‚¹â€œæ‰“å¼€ç‚¹è¯„ APPâ€");
          return;
        } catch (err) {
          console.error("Clipboard API å¤±è´¥", err);
        }
      }

      // ç­–ç•¥ B: execCommand å…œåº•
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const ok = document.execCommand('copy');
        if (ok) toast("âœ… å¤åˆ¶æˆåŠŸ(å…¼å®¹æ¨¡å¼)ï¼");
        else throw new Error("execCommand copy failed");
      } catch (err) {
        toast("âŒ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡æ¡ˆå¤åˆ¶", 2200);
      }
      document.body.removeChild(textArea);
    }

    // æ–°å¢ï¼šæ¢å¤å¤åˆ¶
    async function restoreCopy() {
      const text = localStorage.getItem('dp_review_text') || document.getElementById('review-box').innerText;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          toast("âœ… å·²æ¢å¤å¤åˆ¶ï¼");
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          toast("âœ… å·²æ¢å¤å¤åˆ¶(å…¼å®¹æ¨¡å¼)ï¼");
        }
        document.getElementById('restore-btn').classList.add('hidden');
      } catch (e) {
        toast("âŒ æ¢å¤å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡æ¡ˆå¤åˆ¶", 2200);
      }
    }

    /***********************
     * 4) å”¤èµ·ç‚¹è¯„ï¼šæµè§ˆå™¨å†…å°½é‡å†·å¯åŠ¨æˆåŠŸï¼›å¤±è´¥ç”¨â€œå®˜æ–¹æ‰“å¼€é¡µâ€å…œåº•
     *
     * å…³é”®å˜åŒ–ï¼š
     * - å¾®ä¿¡å†…ï¼šä¸åšè·³è½¬ï¼Œåªæç¤ºå»æµè§ˆå™¨æ‰“å¼€ï¼ˆé¿å…èµ° m.dianping.com è¦†ç›–å‰ªè´´æ¿ï¼‰
     * - Androidï¼šintent + package=com.dianping.v1ï¼Œfallback æŒ‡å‘å®˜æ–¹â€œå·²å®‰è£…æ‰“å¼€â€é¡µ
     * - iOSï¼šå…ˆ schemeï¼Œå¤±è´¥å†å»å®˜æ–¹â€œå·²å®‰è£…æ‰“å¼€â€é¡µ
     ***********************/
      function jumpToApp() {
        // 0) å¾®ä¿¡å†…ç½®ï¼šåªå¼•å¯¼å»æµè§ˆå™¨
        if (/MicroMessenger/i.test(navigator.userAgent)) {
          document.getElementById('wx-mask').classList.remove('hidden');
          toast("è¯·å…ˆåœ¨æµè§ˆå™¨æ‰“å¼€æœ¬é¡µï¼Œå†å”¤èµ·ç‚¹è¯„");
          return;
        }
      
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      
        // 1) å…œåº•é¡µï¼šä¼˜å…ˆå®˜æ–¹â€œæ‰“å¼€/ä¸‹è½½â€é¡µ
        const officialOpenPage = "https://h5.dianping.com/app/app-m-user-growth/index.html";
        // 2) æœ€ç»ˆå…œåº•ï¼šåº”ç”¨å•†åº—ï¼ˆå¾ˆå¤šå®‰å“éƒ½æ”¯æŒï¼Œæ²¡è£…æ—¶æ›´å¯é ï¼‰
        const marketUrl = "market://details?id=com.dianping.v1";
      
        // 3) æ ‡è®°ï¼šæ˜¯å¦åˆ‡å‡ºå»è¿‡ï¼ˆå¦‚æœåˆ‡åˆ° Appï¼Œé¡µé¢ä¼š hidden / blurï¼‰
        let didHide = false;
      
        const markHide = () => { didHide = true; };
        const onVis = () => { if (document.hidden) didHide = true; };
      
        window.addEventListener('blur', markHide, { once: true });
        document.addEventListener('visibilitychange', onVis, { once: true });
      
        // 4) å…³é”®ï¼šå› ä¸ºâ€œæ˜¯å¦æ‰“å¼€ Appâ€çš„ç³»ç»Ÿå¼¹çª—ä¼šé˜»å¡ setTimeout
        //    æ‰€ä»¥æˆ‘ä»¬åœ¨â€œfocus å›æ¥â€çš„æ—¶åˆ»åšå…œåº•åˆ¤æ–­
        const start = Date.now();
      
        function fallbackIfNeeded() {
          const dt = Date.now() - start;
          // åªè¦æ²¡åˆ‡å‡ºå»ï¼ˆdidHide=falseï¼‰ï¼Œä¸”å·²ç»è¿‡äº†è¶³å¤Ÿæ—¶é—´ï¼Œå°±è®¤ä¸ºæ²¡æˆåŠŸæ‰“å¼€
          if (!didHide && dt > 800) {
            // å…ˆå»å®˜æ–¹é¡µï¼ˆå¯èƒ½è§¦å‘ AppLink/å¼•å¯¼æ‰“å¼€ï¼‰
            window.location.href = officialOpenPage;
      
            // å†å…œåº•ï¼š2s åè·³åº”ç”¨å•†åº—ï¼ˆå®˜æ–¹é¡µä¹Ÿæ²¡æ‹‰èµ·æ¥æ—¶ï¼‰
            setTimeout(() => {
              // å¦‚æœç”¨æˆ·è¿˜åœ¨å½“å‰æµè§ˆå™¨é¡µé¢ï¼Œç»§ç»­å…œåº•åˆ° market
              window.location.href = marketUrl;
            }, 2000);
          }
        }
      
        // å¼¹çª—å…³é—­åé€šå¸¸ä¼šè§¦å‘ focusï¼ˆé‡ç‚¹ï¼šè§£å†³â€œå¼¹çª—é˜»å¡å¯¼è‡´è®¡æ—¶å™¨ä¸è·‘â€ï¼‰
        window.addEventListener('focus', fallbackIfNeeded, { once: true });
      
        // 5) çœŸæ­£çš„å”¤èµ·é€»è¾‘
        if (isAndroid) {
          // âœ… æ›´å…¼å®¹çš„ intentï¼šå¸¦ host/pathï¼Œå¹¶æŠŠ fallback_url å†™è¿›å»
          const fallback = encodeURIComponent(officialOpenPage);
      
          // ä½ å¯ä»¥æŠŠ open/pageã€å‚æ•°ç­‰æ”¹æˆä½ æ›´æƒ³è¦çš„è·¯å¾„ï¼Œè¿™é‡Œç”¨ä¸€ä¸ªâ€œé€šç”¨æ‰“å¼€â€
          const intentUrl =
            "intent://dianping/open?src=qr#Intent;" +
            "scheme=dianping;" +
            "package=com.dianping.v1;" +
            "action=android.intent.action.VIEW;" +
            "category=android.intent.category.BROWSABLE;" +
            "launchFlags=0x10000000;" + // æ–°ä»»åŠ¡æ ˆæ‰“å¼€
            "S.browser_fallback_url=" + fallback + ";" +
            "end";
      
          // ç”¨ replace é¿å…å†å²æ ˆæ±¡æŸ“ï¼ˆæœ‰äº›æœºå‹ä½“éªŒæ›´å¥½ï¼‰
          window.location.replace(intentUrl);
      
          // âœ… å†åŠ ä¸€å±‚å…œåº•ï¼šå¦‚æœâ€œæ²¡å¼¹çª—/æ²¡åˆ‡èµ°â€ï¼Œè®¡æ—¶å™¨è¿˜æ˜¯èƒ½è·‘
          setTimeout(fallbackIfNeeded, 1400);
          return;
        }
      
        if (isIOS) {
          // iOS å…ˆ schemeï¼Œå†å…œåº•å®˜æ–¹é¡µ
          window.location.href = "dianping://";
          setTimeout(() => {
            if (!didHide) window.location.href = officialOpenPage;
          }, 1200);
          return;
        }
      
        // å…¶å®ƒå¹³å°
        window.location.href = officialOpenPage;
      }


    // ç‚¹å‡»é®ç½©ä»»æ„åŒºåŸŸå…³é—­ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
    document.getElementById('wx-mask').addEventListener('click', () => {
      document.getElementById('wx-mask').classList.add('hidden');
    });
  </script>
</body>
</html>
