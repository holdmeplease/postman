<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>剧本评价助手 - 调试版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-gradient { background: linear-gradient(135deg, #ff6b6b 0%, #ee0979 100%); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 flex flex-col items-center">

  <!-- 微信引导遮罩 -->
  <div id="wx-mask" class="hidden fixed inset-0 bg-black/90 z-50 animate-fade-in flex flex-col items-end p-6">
    <img src="https://img.icons8.com/ios/100/ffffff/curved-arrow.png" class="w-16 h-16 rotate-[270deg] mb-4" />
    <div class="text-white text-right">
      <h2 class="text-2xl font-bold">请点击右上角 [...]</h2>
      <p class="text-lg">选择 <span class="text-pink-400 font-bold">[在浏览器打开]</span></p>
      <p class="text-sm mt-2 opacity-80">为避免剪贴板被覆盖，请在浏览器打开后再唤起点评</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/80 text-white text-sm px-4 py-2 rounded-full z-50 animate-fade-in">
    提示
  </div>

  <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden mb-6 mt-4">
    <div class="aspect-square bg-gray-100 relative">
      <img id="role-img" src="" class="w-full h-full object-cover hidden" />
      <div id="img-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">正在准备角色...</div>
    </div>

    <div class="p-6">
      <h2 id="role-name" class="text-2xl font-black text-gray-800 mb-2">加载中...</h2>
      <div id="review-box" class="bg-gray-50 p-4 rounded-2xl text-gray-600 leading-relaxed text-sm">正在加载文案...</div>

      <!-- 恢复复制按钮（剪贴板被覆盖时用） -->
      <button id="restore-btn"
              onclick="restoreCopy()"
              class="hidden mt-4 w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 rounded-xl active:scale-95 transition-all">
        🔁 文案可能被覆盖，点我恢复复制
      </button>
    </div>
  </div>

  <div class="w-full max-w-md space-y-4">
    <div class="flex gap-3">
      <button onclick="copyReviewText()"
              class="flex-1 bg-white border-2 border-pink-500 text-pink-600 font-bold py-4 rounded-xl active:scale-95 transition-all">
        1. 复制评价文案
      </button>

      <button onclick="jumpToApp()"
              class="flex-1 btn-gradient text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
        2. 打开点评 APP
      </button>
    </div>

    <p class="text-center text-gray-400 text-[10px]">
      建议：先点1复制，再点2打开点评；如发现剪贴板被改了，点“恢复复制”。
    </p>

    <!-- 手动打开提示区（冷启动失败时显示） -->
    <div id="manual-open-box"
         class="hidden w-full max-w-md bg-white border border-gray-200 rounded-2xl p-4 text-sm text-gray-700">
      <div class="font-bold mb-1">如果没有自动打开点评：</div>
      <ol class="list-decimal pl-5 space-y-1">
        <li>请手动打开「大众点评」App（桌面/最近任务）。</li>
        <li>回到本页，点击上方的「🔁 恢复复制」再去粘贴评价。</li>
      </ol>
    </div>
  </div>

  <script>
    /***********************
     * 0) 小工具
     ***********************/
    function toast(msg, ms = 1600) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => el.classList.add('hidden'), ms);
    }

    function isWechat() { return /MicroMessenger/i.test(navigator.userAgent); }

    // 微信环境提示遮罩
    if (isWechat()) {
      document.getElementById('wx-mask').classList.remove('hidden');
      document.getElementById('wx-mask').addEventListener('click', () => {
        document.getElementById('wx-mask').classList.add('hidden');
      });
    }

    /***********************
     * 1) 初始化数据（示例）
     ***********************/
    const urlParams = new URLSearchParams(window.location.search);
    const roleId = urlParams.get('id') || '0';
    const roles = [
      { name: "欧阳千金", img: "img1.jpg", text: "这次玩的剧本杀太精彩了！我抽到的角色很有深度，剧情反转再反转，强烈推荐！" },
      { name: "神秘管家", img: "img2.jpg", text: "整场下来氛围感拉满，店员小姐姐服务也特别好，评价必给五星！" }
    ];
    const role = roles[parseInt(roleId)] || roles[0];

    document.getElementById('role-name').innerText = role.name;
    document.getElementById('review-box').innerText = role.text;

    const img = document.getElementById('role-img');
    img.src = role.img;
    img.onload = () => {
      img.classList.remove('hidden');
      document.getElementById('img-placeholder').classList.add('hidden');
    };

    /***********************
     * 2) 复制逻辑：复制成功后把文案持久化，防止被覆盖
     ***********************/
    async function copyReviewText() {
      const text = document.getElementById('review-box').innerText;

      // 存档：后面可“恢复复制”
      localStorage.setItem('dp_review_text', text);
      localStorage.setItem('dp_review_ts', String(Date.now()));
      document.getElementById('restore-btn').classList.add('hidden');
      document.getElementById('manual-open-box').classList.add('hidden');

      // 策略 A: Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          toast("✅ 复制成功！现在点“打开点评 APP”");
          return;
        } catch (err) {
          console.error("Clipboard API 失败", err);
        }
      }

      // 策略 B: execCommand 兜底
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const ok = document.execCommand('copy');
        if (ok) toast("✅ 复制成功(兼容模式)！");
        else throw new Error("execCommand copy failed");
      } catch (err) {
        toast("❌ 自动复制失败，请手动长按文案复制", 2200);
      }
      document.body.removeChild(textArea);
    }

    // 恢复复制
    async function restoreCopy() {
      const text = localStorage.getItem('dp_review_text') || document.getElementById('review-box').innerText;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          toast("✅ 已恢复复制！");
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          toast("✅ 已恢复复制(兼容模式)！");
        }
        document.getElementById('restore-btn').classList.add('hidden');
      } catch (e) {
        toast("❌ 恢复复制失败，请手动长按文案复制", 2200);
      }
    }

    /***********************
     * 3) 唤起逻辑（方案A）
     * - 不走点评官方H5（避免剪贴板风控覆盖）
     * - 能热启动就热启动；冷启动失败就提示用户手动打开点评
     ***********************/
    function jumpToApp() {
      // 微信内：只引导外部浏览器
      if (isWechat()) {
        document.getElementById('wx-mask').classList.remove('hidden');
        toast("请在浏览器打开本页，再尝试打开点评");
        return;
      }

      const ua = navigator.userAgent;
      const isAndroid = /Android/i.test(ua);
      const isHarmony = /HarmonyOS/i.test(ua) || /HUAWEI/i.test(ua) || /Huawei/i.test(ua);

      // 兜底到应用市场（不会覆盖剪贴板）
      const marketUrl = "market://details?id=com.dianping.v1";

      // 手动提示
      const showManualHint = () => {
        toast("未能自动打开点评：请手动打开大众点评后回来点“恢复复制”", 2400);
        document.getElementById('restore-btn')?.classList.remove('hidden');
        document.getElementById('manual-open-box')?.classList.remove('hidden');
      };

      // 点击前把文案存起来（防止任何情况丢）
      const text = localStorage.getItem('dp_review_text') || document.getElementById('review-box').innerText;
      localStorage.setItem('dp_review_text', text);
      localStorage.setItem('dp_review_ts', String(Date.now()));

      // 回到页面后给恢复按钮
      document.getElementById('restore-btn')?.classList.remove('hidden');

      // 监测是否真正切走（热启动成功时会触发）
      let didHide = false;
      const markHide = () => { didHide = true; };
      window.addEventListener('blur', markHide, { once: true });
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) didHide = true;
        else document.getElementById('restore-btn')?.classList.remove('hidden');
      }, { once: true });

      if (!isAndroid) {
        showManualHint();
        return;
      }

      // 1) scheme 尝试（热启动成功率高）
      const schemeTry = () => {
        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        iframe.src = "dianping://";
        document.body.appendChild(iframe);
        setTimeout(() => document.body.removeChild(iframe), 600);
      };

      // 2) intent 尝试（部分浏览器可用；Firefox 跳过）
      const intentTry = () => {
        const isFirefox = /Firefox/i.test(ua);
        if (isFirefox) return;
        const intentUrl =
          "intent://dianping/open#Intent;" +
          "scheme=dianping;" +
          "package=com.dianping.v1;" +
          "action=android.intent.action.VIEW;" +
          "category=android.intent.category.BROWSABLE;" +
          "launchFlags=0x10000000;" +
          "end";
        window.location.href = intentUrl;
      };

      schemeTry();
      setTimeout(() => {
        intentTry();
      }, isHarmony ? 120 : 50);

      // 兜底：没切走就提示手动打开（不跳点评H5，避免剪贴板覆盖）
      setTimeout(() => {
        if (!didHide) {
          // 如果你想更“强”，可以先尝试跳应用市场确认安装/更新：
          // window.location.href = marketUrl;
          showManualHint();
        }
      }, 1400);
    }
  </script>
</body>
</html>
